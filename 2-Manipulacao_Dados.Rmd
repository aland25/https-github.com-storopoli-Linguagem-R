---
title: "Manipulação de Dados"
description: "dplyr, readr, tidyr, stringr"
author:
  - name: Jose Storopoli
    url: https://scholar.google.com/citations?user=xGU7H1QAAAAJ&hl=en
    affiliation: UNINOVE
    affiliation_url: https://www.uninove.br
    orcid_id: 0000-0002-0559-5176
date: April 7, 2021
citation_url: https://storopoli.io/Linguagem-R/2-Manipulacao_Dados.html
slug: storopoli2021manipulacaodadosR
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<link rel="stylesheet" href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css"/>

```{r tidy-data, echo=FALSE, fig.align='center', fig.cap='Tidy Data'}
knitr::include_graphics("images/tidydata_1.jpg")
```

## O que é *Tidy Data*?

* cada variável uma coluna
* cada observação uma linha
* cada célula uma mensuração única

## O pipe `%>%`

`x %>% f(y)` vira `f(x, y)`


`x %>% f(y) %>% f(z)` vira `f(f(x, y), z)`

```{r magrittr}
library(magrittr)
```

## Como ler dados com o `{readr}`

Vamos começar com o primeiro passo da análise de dados: a importação dos dados.

Para isso o [`{tidyverse}`](https://www.tidyverse.org) possui um pacote chamado [`{readr}`](https://readr.tidyverse.org/).

* `read_csv()`: CSV padrão americano
* `read_csv2()`: CSV padrão europeu/brasileiro
* `read_tsv()`: TSV
* `read_delim()`: Coringa

Na pasta `datasets/` temos diversos datasets interessantes:

* [`adult.csv`](https://archive.ics.uci.edu/ml/datasets/Adult)
* [`countries_of_the_world.csv`](https://www.kaggle.com/fernandol/countries-of-the-world)
* [`covid_19_data.csv`](https://www.kaggle.com/sudalairajkumar/novel-corona-virus-2019-dataset#covid_19_data.csv): versão 147 de 27/02/2021.

Se vocês quiserem ler arquivos `.xlsx` ou `.xls` usem o pacote [`{readxl}`](https://readxl.tidyverse.org/)

### `col_types` -- O argumento que eu mais uso em `read_*()`

```{r readr-adult}
library(readr)

```

```{r readr-countries_of_the_world}

```

```{r readr-covid}

```

## Manipulação de dados com o [`{dplyr}`](https://dplyr.tidyverse.org/)

```{r dplyr-image, echo=FALSE, fig.align='center', fig.cap='dplyr'}
knitr::include_graphics("images/dplyr_wrangling.png")
```

### Selecionar Variáveis -- `dplyr::select()`

```{r dplyr-select}
library(dplyr)

```

> OBS: Tem a função `rename_with` do `{dplyr}` versão 1.0. 

```{r dplyr-rename_with}

```

```{r mais-select}

```

> Professor eu gosto de camelCase e agora?

Não tema, tem o pacote [`{janitor}`](https://garthtarr.github.io/meatR/janitor.html)

```{r janitor}
library(janitor)

```

#### Ordenar variáveis com `dplyr::arrange()`

```{r adult-arrange}

```

#### Frequencias com `dplyr::count()`

> OBS: vamos ver muito essa função quando falarmos de `group_by()`

```{r adult-count}

```

### Manipular Variáveis -- `dplyr::mutate()`

> Odeio potência de 10

use `options(scipen = 999, digits = 2)`

```{r dplyr-mutate}
options(scipen = 999, digits = 2)

```

O mutate ele altera variáveis *in-place* ou adiciona novas variáveis preservando as existentes. Mas temos também o `transmute` adiciona novas variáveis e *dropa* todas as demais.

```{r dplyr-transmute}

```

Quase todos os verbos (como vocês viram lá em cima) do `{dplyr}` tem os sufixos `_if`, `_all` e `_at`. Por exemplo:

```{r dplyr-mutate_all}

```
#### `dplyr::if_else` e `dplyr::case_when`

Usamos o `if_else` quando queremos fazer um teste booleano e gerar um valor caso o teste seja verdadeiro e outro valor caso o teste seja falso. Basicamente um `if ... else ...`:

```{r adult-if_else}

```

Temos algo um pouco mais flexível, poderoso; porém verboso. Esse é o `dplyr::case_when`:

```{r adult-case_when}

```

### Agrupar e Sumarizar Variáveis -- `dplyr::group_by()` e `dplyr::summarise()`

Agrupamos dados com o `dplyr::group_by()` e depois usamos o `dplyr::summarise()` (também existe na versão inglês *americano* como dplyr::summarize()`) para computar valores dos grupos. Este tipo de análise é chamada comumente de *split-apply-combine*.

```{r adult-group_by}

```

```{r covid-group_by}

```

Eu posso agrupar por vários grupos por exemplo:

```{r covid-group_by-multiple}
library(tidyr)

```

Lembra que todos os verbos do `{dplyr}` tem o sufixo `_all`, `_if` e `_at`?

```{r dplyr-summarise_if}

```

Não sei o futuro das coisas `_if`, `_at` e `_all`, pois o *lifecycle* está em *superseded*. Então se vocês quiserem um código robusto ao tempo usem o `across`:

```{r dplyr-across}

```

> Qual a diferença de `grouped_df` e `tibble`?

Se você estiver no mundo do `{tidyverse}` nenhuma, mas se você for dar um pipe `%>%` de um `grouped_df` em algo que não é do `{tidyverse}` e que somente aceita `tibbles` e `data.frames` você vai receber um erro. Nesses casos antes de "pipar" `%>%` você faz um `ungroup()`:

```{r ex-ungroup}

```

```{r limpeza-total}

```


### Joins com `dplyr::join*`

Vamos para a cereja do bolo que é os famosos joins. `{dplyr}` tem os seguintes joins:

* `inner_join()`: inclui todas as observações de x e y.
* `left_join()`: inclui todas as observações de x.
* `right_join()`: inclui todas as observações de y.
* `full_join()`: inclui todas as observações de x ou y.

> OBS: participação especial do [`{stringr}`](https://stringr.tidyverse.org/)

```{r join-covid-countries}
library(stringr)

```

```{r covid-china}

```

```{r countries-china}

```

```{r covid-join-plot}
library(ggplot2)

  
```


## Mais transformações para formato `Tidy Data` com [`{tidyr}`](https://tidyr.tidyverse.org/)

O `tidyr` tem o famoso `drop_na()`. Então se vocês forem usar o `drop_na()` junto com o `dplyr` não esqueçam do `library(tidyr)`.

> OBS: vocês podem importar TODO o `{tidyverse}` de uma vez só com o `library(tidyverse)`

Em especial temos as funções `pivot_longer()` e `pivot_wider()`:

* *Dataset* `tidyr::relig_income`
* *Dataset* `tidyr::billboard`
* *Dataset* `tidyr::fish_encounters`

```{r tidyr-relig_income}
library(tidyr)

```

```{r tidyr-billboard}

```

```{r tidyr-fish_encounters}

```


Além do `unnest_wider()` e `unnest_longer()`:

* *Dataset* `repurrrsive::got_chars`

```{r repurrrsive}
library(repurrrsive)

```

Uma outra maneira

```{r tidyr-separate}

```

## Extras

### Converter verbos `{dplyr}` em SQL com o [`{dbplyr}`](https://dbplyr.tidyverse.org/)

```{r dbplyr}
library(dbplyr, warn.conflicts = FALSE)

```

Posso muito bem converter verbos `{dplyr}` para `SQL` (para todos os *amantes* de SQL)

```{r dbplyr-stuff}

```


### Big Data com [`{arrow}`](https://arrow.apache.org/docs/r/)

## Ambiente

```{r sessionInfo}
sessionInfo()
```
